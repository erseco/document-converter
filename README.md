# Document Converter

A static microservice that uses ZetaJS (LibreOffice WASM) to convert documents in the browser. Supports deployment on Vercel and GitHub Pages.

## Features

- **Client-side document conversion** using LibreOffice WASM via ZetaJS
- **Iframe-compatible** with proper CORS and security headers for SharedArrayBuffer support
- **Multiple format support**: PDF, DOCX, XLSX, PPTX, ODT, ODS, ODP, HTML, TXT, RTF, PNG, JPG
- **Origin whitelist** optional security feature to restrict which domains can use the converter
- **GitHub Pages support** via Service Worker COOP/COEP headers and locally hosted WASM files

## Deployment

### Option 1: Vercel (Recommended)

Deploy to Vercel:

```bash
vercel
```

Or click the deploy button:

[![Deploy with Vercel](https://vercel.com/button)](https://vercel.com/new/clone?repository-url=https://github.com/erseco/document-converter)

The Vercel deployment uses the ZetaOffice CDN for WASM files.

### Option 2: GitHub Pages

GitHub Pages deployment uses a GitHub Actions workflow to:
1. Download ZetaOffice WASM files from the CDN
2. Copy zetajs library files from npm
3. Deploy everything to GitHub Pages

**Setup:**
1. Enable GitHub Pages in your repository settings, using "GitHub Actions" as the source
2. The workflow will automatically run on push to `main` branch
3. Your converter will be available at `https://yourusername.github.io/document-converter/`

**Files in the `docs/` folder:**
- `coi-serviceworker.js` - Service Worker that adds COOP/COEP headers
- `index.html` - Main page that loads the Service Worker and ZetaJS
- `converter.js` - Message handler for iframe communication

**Generated by GitHub Actions:**
- `wasm/` - ZetaOffice WASM files (soffice.js, soffice.wasm, soffice.data)
- `vendor/zetajs/` - zetajs library files (zeta.js, zetaHelper.js)

## Usage

### Embedding in an iframe

**Vercel deployment:**
```html
<iframe id="converter" src="https://your-vercel-deployment.vercel.app"></iframe>
```

**GitHub Pages deployment:**
```html
<iframe id="converter" src="https://yourusername.github.io/document-converter/"></iframe>
```

### With origin whitelist (optional security)

To restrict which domains can communicate with the converter, add the `origins` query parameter:

```html
<iframe id="converter" src="https://your-vercel-deployment.vercel.app?origins=https://example.com,https://another.com"></iframe>
```

### Sending documents for conversion

```javascript
const iframe = document.getElementById('converter');

// Wait for the converter to be ready
window.addEventListener('message', (event) => {
    if (event.data.type === 'ready') {
        console.log('Converter is ready!');
    }
    
    if (event.data.type === 'result') {
        // Handle the converted blob
        const blob = event.data.blob;
        const url = URL.createObjectURL(blob);
        // Download or display the result
    }
    
    if (event.data.type === 'error') {
        console.error('Conversion error:', event.data.error);
    }
});

// Convert a document
async function convertDocument(file, format = 'pdf') {
    const arrayBuffer = await file.arrayBuffer();
    
    iframe.contentWindow.postMessage({
        type: 'convert',
        buffer: arrayBuffer,  // or 'file' for WordPress compatibility
        format: format,  // 'pdf', 'docx', 'xlsx', etc.
        requestId: Date.now()
    }, '*');
}
```

### WordPress Playground Integration

The GitHub Pages version is specifically designed to work as an isolated iframe within WordPress Playground:

```javascript
// In WordPress
const converterIframe = document.createElement('iframe');
converterIframe.src = 'https://yourusername.github.io/document-converter/';
document.body.appendChild(converterIframe);

// Send file for conversion (supports both 'buffer' and 'file' property names)
converterIframe.contentWindow.postMessage({
    type: 'convert',
    file: arrayBuffer,  // ArrayBuffer of the document
    format: 'pdf',
    requestId: 'unique-id'
}, '*');

// Listen for results
window.addEventListener('message', (event) => {
    if (event.data.type === 'result') {
        const pdfBlob = event.data.blob;
        // Handle the converted PDF
    }
});
```

## Security Headers

### Vercel
The `vercel.json` configuration includes required headers for SharedArrayBuffer support:

- `Cross-Origin-Opener-Policy: same-origin`
- `Cross-Origin-Embedder-Policy: require-corp`
- `Content-Security-Policy` with `frame-ancestors *` to allow embedding

### GitHub Pages
The `coi-serviceworker.js` Service Worker adds the required headers via fetch interception:

- `Cross-Origin-Opener-Policy: same-origin`
- `Cross-Origin-Embedder-Policy: require-corp` (or `credentialless` as fallback)
- `Cross-Origin-Resource-Policy: cross-origin`

## Supported Formats

### Input formats
Any format supported by LibreOffice (DOC, DOCX, ODT, XLS, XLSX, ODS, PPT, PPTX, ODP, etc.)

### Output formats
- **PDF** - Portable Document Format
- **DOCX** - Microsoft Word
- **XLSX** - Microsoft Excel
- **PPTX** - Microsoft PowerPoint
- **ODT** - OpenDocument Text
- **ODS** - OpenDocument Spreadsheet
- **ODP** - OpenDocument Presentation
- **HTML** - Web page
- **TXT** - Plain text
- **RTF** - Rich Text Format
- **PNG** - Image
- **JPG** - Image

## License

MIT