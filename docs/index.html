<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Converter - ZetaJS (GitHub Pages)</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: #f5f5f5;
        }
        .status {
            text-align: center;
            padding: 20px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden { display: none; }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 4px;
            padding: 10px 15px;
            margin: 10px 0;
            color: #856404;
            font-size: 14px;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            padding: 10px 15px;
            margin: 10px 0;
            color: #721c24;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="status">
        <div class="spinner" id="spinner"></div>
        <p id="statusText">Initializing...</p>
        <div id="coiWarning" class="warning hidden">
            Cross-Origin Isolation is not enabled. Activating Service Worker...
        </div>
    </div>

    <!-- Hidden canvas required by ZetaOffice WASM -->
    <canvas id="qtcanvas" style="display: none"></canvas>

    <!-- 
        CRITICAL: Load the COI Service Worker FIRST before any other scripts.
        This enables COOP/COEP headers via Service Worker for GitHub Pages
        where server headers cannot be configured.
    -->
    <script src="coi-serviceworker.js"></script>

    <script>
        // Check cross-origin isolation status after COI service worker loads
        (function() {
            const statusText = document.getElementById('statusText');
            const coiWarning = document.getElementById('coiWarning');
            
            function updateStatus(message) {
                if (statusText) statusText.textContent = message;
            }
            
            // Wait a moment for service worker to potentially trigger a reload
            setTimeout(function() {
                if (!window.crossOriginIsolated) {
                    coiWarning.classList.remove('hidden');
                    updateStatus('Waiting for Cross-Origin Isolation...');
                    
                    // If still not isolated after service worker should have activated,
                    // show an error but try to continue anyway
                    setTimeout(function() {
                        if (!window.crossOriginIsolated) {
                            console.warn('Cross-Origin Isolation could not be enabled. SharedArrayBuffer may not work.');
                            coiWarning.textContent = 'Warning: Cross-Origin Isolation could not be enabled. ' +
                                'Some features may not work correctly.';
                            // Continue anyway - the converter will show its own error if it fails
                            loadConverter();
                        }
                    }, 3000);
                } else {
                    console.log('Cross-Origin Isolation is enabled');
                    loadConverter();
                }
            }, 100);
            
            function loadConverter() {
                coiWarning.classList.add('hidden');
                updateStatus('Loading converter module...');
                
                // Dynamically import the converter module
                import('./converter.js')
                    .then(function(module) {
                        // Initialize ZetaJS
                        return module.initZetaJS();
                    })
                    .catch(function(error) {
                        console.error('Failed to load converter:', error);
                        updateStatus('Error: ' + error.message);
                        document.getElementById('spinner').classList.add('hidden');
                        
                        // Notify parent of error
                        if (window.parent !== window) {
                            window.parent.postMessage({ 
                                type: 'error', 
                                error: 'Failed to load converter: ' + error.message 
                            }, '*');
                        }
                    });
            }
        })();
    </script>
</body>
</html>
